---
kind: pipeline
type: docker
name: default

steps:

- name: submodules
  image: alpine/git
  commands:
  - git submodule update --init --recursive

- name: restore-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    restore: true
    mount:
      - ./node_modules
  depends_on:
  - submodules

- name: school
  image: node:18
  commands:
  - apt-get update && apt-get install rsync -y build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
  - mkdir -p $HOME/.ssh
  - ssh-keyscan -t rsa github.com >> $HOME/.ssh/known_hosts
  - echo "$GITHUB_PRIVATE_KEY" > "$HOME/.ssh/id_rsa"
  - chmod 0600 $HOME/.ssh/id_rsa
  - yarn install --frozen-lockfile
  - npm run sync
  - npm run deploy
  environment:
    USE_SSH: true
    WITHOUT_DOCS: "true"
    GIT_USER: $DRONE_COMMIT_AUTHOR
    NODE_OPTIONS: "--max_old_space_size=12288"
    GITHUB_PRIVATE_KEY:
      from_secret: "git_deploy_private_key"
    UMAMI_SRC:
      from_secret: "UMAMI_SRC"
    UMAMI_ID:
      from_secret: "UMAMI_ID"
    DOMAIN:
      from_secret: "DOMAIN"
    ALGOLIA_APP_ID:
      from_secret: "ALGOLIA_APP_ID"
    ALGOLIA_API_KEY:
      from_secret: "ALGOLIA_API_KEY"
    ALGOLIA_INDEX_NAME:
      from_secret: "ALGOLIA_INDEX_NAME"
  when:
    event:
      include:
      - push
      - pull_request
  depends_on:
  - restore-cache

- name: docs
  image: node:18
  commands:
  - apt-get update && apt-get install rsync -y build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
  - mkdir -p $HOME/.ssh
  - ssh-keyscan -t rsa github.com >> $HOME/.ssh/known_hosts
  - echo "$GITHUB_PRIVATE_KEY" > "$HOME/.ssh/id_rsa"
  - chmod 0600 $HOME/.ssh/id_rsa
  - yarn install --frozen-lockfile
  - npm run cleanup
  - npm run sync
  - npm run deploy
  environment:
    USE_SSH: true
    GIT_USER: $DRONE_COMMIT_AUTHOR
    NODE_OPTIONS: "--max_old_space_size=12288"
    GITHUB_PRIVATE_KEY:
      from_secret: "git_deploy_private_key_docs"
    UMAMI_SRC:
      from_secret: "UMAMI_SRC"
    UMAMI_ID:
      from_secret: "UMAMI_ID"
    DOMAIN:
      from_secret: "DOCS_DOMAIN"
    DOCS_ONLY: "true"
    GH_DEPLOY_BRANCH: "main"
    GH_PROJECT: "ofi-blog-docs"
  when:
    event:
      include:
      - push
      - pull_request
  depends_on:
  - school

- name: rebuild-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    rebuild: true
    mount:
      - ./node_modules
  depends_on:
  - school

- name: notify
  image: plugins/webhook
  settings:
    urls:
      from_secret: NODE_RED_WEBHOOK
  when:
    status:
    - success
    - failure
  depends_on:
    - school

volumes:
  - name: cache
    host: 
      path: /var/lib/dokku/data/storage/hfr-drone-runner/cache

trigger:
  branch:
  - main